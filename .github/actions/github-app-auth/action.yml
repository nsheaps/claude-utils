name: 'GitHub App Authentication'
description: 'Authenticate as a GitHub App and configure git credentials'

inputs:
  app-id:
    description: 'GitHub App ID'
    required: true
  private-key:
    description: 'GitHub App private key'
    required: true

outputs:
  token:
    description: 'GitHub App installation token'
    value: ${{ steps.app-token.outputs.token }}
  app-slug:
    description: 'GitHub App slug'
    value: ${{ steps.app-token.outputs.app-slug }}
  user-id:
    description: 'Bot user ID'
    value: ${{ steps.get-user-id.outputs.user-id }}
  user-name:
    description: 'Bot user name for commits'
    value: ${{ steps.get-user-id.outputs.user-name }}

runs:
  using: 'composite'
  steps:
    - name: Generate GitHub App token
      id: app-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ inputs.app-id }}
        private-key: ${{ inputs.private-key }}

    - name: Get bot user ID
      id: get-user-id
      shell: bash
      env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}
      run: |
        APP_SLUG="${{ steps.app-token.outputs.app-slug }}"
        USER_NAME="${APP_SLUG}[bot]"
        USER_ID=$(gh api "/users/${USER_NAME}" --jq .id)
        echo "user-id=$USER_ID" >> "$GITHUB_OUTPUT"
        echo "user-name=$USER_NAME" >> "$GITHUB_OUTPUT"

    - name: Configure git
      shell: bash
      env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}
      run: |
        USER_NAME="${{ steps.get-user-id.outputs.user-name }}"
        USER_ID="${{ steps.get-user-id.outputs.user-id }}"

        # Setup gh auth and export tokens for subsequent steps
        gh auth setup-git
        echo "GH_TOKEN=${GH_TOKEN}" >> $GITHUB_ENV
        echo "GITHUB_TOKEN=${GH_TOKEN}" >> $GITHUB_ENV

        git config --global user.name "$USER_NAME"
        git config --global user.email "${USER_ID}+${USER_NAME}@users.noreply.github.com"

        # Configure credential helper for HTTPS
        git config --global credential.helper store
        echo "https://x-access-token:${GH_TOKEN}@github.com" > ~/.git-credentials
