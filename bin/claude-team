#!/usr/bin/env bash
# claude-team - Launch Claude Code with agent teams enabled
# Usage: claude-team [OPTIONS] [CLAUDE_ARGS...]
#
# Interactive helper for working with Claude Code agent teams.
# Enables the experimental agent teams feature and lets you
# choose teammate display mode interactively.
#
# Options:
#   -m, --mode MODE   Teammate mode: auto, in-process, tmux (skips prompt)
#   --no-interactive   Skip interactive prompts, use defaults
#   -h, --help         Show this help message
#
# Examples:
#   claude-team                    # Interactive mode selection
#   claude-team --mode tmux        # Use tmux split panes
#   claude-team --mode in-process  # Use in-process mode
#   ct                             # Shorthand alias

set -euo pipefail

SCRIPT_DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
source "$SCRIPT_DIR/lib/claude.lib.sh"

show_help() {
  cat <<'EOF'
claude-team - Launch Claude Code with agent teams enabled

USAGE:
  claude-team [OPTIONS] [CLAUDE_ARGS...]
  ct [OPTIONS] [CLAUDE_ARGS...]

Enables Claude Code's experimental agent teams feature and launches a session.
Without flags, interactively prompts for teammate display mode.

OPTIONS:
  -m, --mode MODE     Teammate display mode (skips interactive prompt)
                        auto        - Auto-detect best backend (default)
                        in-process  - Hidden sessions, Shift+Up/Down to switch
                        tmux        - Visible split panes (auto-launches tmux -CC)
  --no-interactive    Skip interactive prompts, use default mode (auto)
  -h, --help          Show this help message

KEYBOARD CONTROLS (once in a team session):
  Shift+Up/Down   Cycle through teammates (in-process mode)
  Enter            View selected teammate
  Escape           Interrupt teammate's turn
  Ctrl+T           Toggle task list
  Shift+Tab        Toggle delegate mode (lead coordination only)

EXAMPLES:
  claude-team                          # Interactive mode picker
  claude-team --mode tmux              # Tmux split panes
  claude-team --mode in-process        # In-process mode
  ct --mode auto -- --resume           # Auto mode, resume session

ENVIRONMENT:
  CLAUDE_TEAM_DEFAULT_MODE    Default teammate mode when using --no-interactive
                              (default: auto)

For more info on agent teams, see:
  https://code.claude.com/docs/en/agent-teams
EOF
  exit 0
}

TEAMMATE_MODE=""
INTERACTIVE=true
CLAUDE_ARGS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
  -m | --mode)
    if [[ -z "${2:-}" ]]; then
      fatal "--mode requires a value: auto, in-process, or tmux"
    fi
    case "$2" in
    auto | in-process | tmux) TEAMMATE_MODE="$2" ;;
    *) fatal "Invalid mode '$2'. Must be: auto, in-process, or tmux" ;;
    esac
    shift 2
    ;;
  --no-interactive)
    INTERACTIVE=false
    shift
    ;;
  -h | --help)
    show_help
    ;;
  --)
    shift
    CLAUDE_ARGS+=("$@")
    break
    ;;
  *)
    CLAUDE_ARGS+=("$1")
    shift
    ;;
  esac
done

# If no mode specified and interactive, prompt for it
if [[ -z "$TEAMMATE_MODE" ]]; then
  if [[ "$INTERACTIVE" == true ]] && [[ -t 0 ]]; then
    check_and_install gum

    info "Agent teams lets Claude orchestrate multiple parallel sessions."
    echo ""
    TEAMMATE_MODE=$(gum choose \
      --header "Select teammate display mode:" \
      --cursor.foreground="212" \
      "auto       - Auto-detect best backend" \
      "in-process - Hidden sessions (Shift+Up/Down to switch)" \
      "tmux       - Visible split panes (requires tmux/iTerm2)")

    # Extract just the mode name (before the space/dash)
    TEAMMATE_MODE="${TEAMMATE_MODE%% *}"

    if [[ -z "$TEAMMATE_MODE" ]]; then
      echo "Cancelled."
      exit 0
    fi
  else
    TEAMMATE_MODE="${CLAUDE_TEAM_DEFAULT_MODE:-auto}"
  fi
fi

# Check tmux requirements if tmux mode selected
LAUNCH_TMUX_CC=false
if [[ "$TEAMMATE_MODE" == "tmux" ]]; then
  if ! command -v tmux &>/dev/null; then
    check_and_install tmux
  fi
  if [[ -z "${TMUX:-}" ]]; then
    LAUNCH_TMUX_CC=true
    info "Not in a tmux session. Will auto-launch with tmux -CC (iTerm2 control mode)."
  fi
fi

# Build orchestrator system prompt
ORCHESTRATOR_PROMPT="You are an orchestrator of an agent team using claude code. You do not perform any tasks, only create/launch teammates and coordinate between them."

# Build hooks settings JSON
HOOKS_SETTINGS_JSON='{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "echo \"[agent-teams] Session started in agent team orchestrator mode\" >&2"
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "echo \"[agent-teams] Session stopping. Any previously created team will be destroyed and must be recreated on next launch.\" >&2"
          }
        ]
      }
    ]
  }
}'

# Build the command flags
TEAM_FLAGS=(
  "--teammate-mode" "$TEAMMATE_MODE"
  "--permission-mode" "delegate"
  "--continue"
  "--append-system-prompt" "$ORCHESTRATOR_PROMPT"
  "--settings" "$HOOKS_SETTINGS_JSON"
)

export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1

success "Launching Claude agent team orchestrator (mode: $TEAMMATE_MODE)"
echo ""
hint "Controls: Shift+Up/Down (switch), Ctrl+T (tasks), Shift+Tab (delegate)"
echo ""

claude_check_settings_backup
trap claude_check_settings_backup EXIT

if [[ "$LAUNCH_TMUX_CC" == true ]]; then
  # Auto-launch tmux -CC (control mode) so iTerm2 renders native windows/tabs.
  # CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 is already exported and inherited.
  # The tmux session ends automatically when claude exits.
  info "Starting tmux -CC session..."
  exec tmux -CC new-session -- claude --dangerously-skip-permissions "${TEAM_FLAGS[@]}" "${CLAUDE_ARGS[@]}"
else
  command claude --dangerously-skip-permissions "${TEAM_FLAGS[@]}" "${CLAUDE_ARGS[@]}"
fi
