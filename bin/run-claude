#!/usr/bin/env bash
# run-claude - Launch Claude Code with bypass permissions through happy
# Usage: run-claude [ARGS...]
#
# Wrapper that routes claude invocations through happy with bypass
# permissions enabled by default. Use this as your main entry point.
#
# Options:
#   -h, --help    Show this help message
#
# Examples:
#   run-claude              # Start new session
#   run-claude --continue   # Continue last session
#   run-claude --resume     # Resume last session

set -euo pipefail

# Source shared Claude CLI helpers
SCRIPT_DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
source "$SCRIPT_DIR/lib/claude.lib.sh"

show_help() {
  sed -n '2,15p' "$0" | sed 's/^# //' | sed 's/^#//'
  echo "==============================="
  echo -e "The following is the --help result from claude itself\n\n"
  claudeish --help
  exit 0
}

for arg in "$@"; do
  case "$arg" in
  -h | --help) show_help ;;
  esac
done

CHECK_FOR_UPDATES_ON_FORMULAE=("claude-code" "claude-utils")
AVAILABLE_UPDATES="$(HOMEBREW_NO_AUTO_UPDATE=1 brew outdated --verbose "${CHECK_FOR_UPDATES_ON_FORMULAE[@]}" || true)"
if [[ -n "$AVAILABLE_UPDATES" ]]; then
  cat <<EOF
Updates are available for the following formulae:"
$(echo "$AVAILABLE_UPDATES" | xargs -I{} echo " - local {} remote")

EOF
  if gum confirm "Do you want to upgrade them now?"; then
    brew upgrade "${CHECK_FOR_UPDATES_ON_FORMULAE[@]}" || echo "looks like upgrade failed, continuing anyway..."
  fi
fi

# Update installed Claude Code plugins (with 5-hour cooldown)
CLAUDE_HOME="${CLAUDE_HOME:-$HOME/.claude}"
INSTALLED_PLUGINS_FILE="$CLAUDE_HOME/plugins/installed_plugins.json"
PLUGIN_CHECK_TIMESTAMP="$CLAUDE_HOME/.plugin-check-timestamp"
PLUGIN_CHECK_COOLDOWN_SECONDS=$((5 * 60 * 60)) # 5 hours

_plugin_check_needed() {
  if [[ ! -f "$PLUGIN_CHECK_TIMESTAMP" ]]; then
    return 0 # No timestamp â€” check needed
  fi
  local last_check now elapsed
  last_check="$(cat "$PLUGIN_CHECK_TIMESTAMP")"
  now="$(date +%s)"
  elapsed=$((now - last_check))
  if [[ $elapsed -ge $PLUGIN_CHECK_COOLDOWN_SECONDS ]]; then
    return 0 # Cooldown expired
  fi
  return 1 # Still within cooldown
}

if [[ -f "$INSTALLED_PLUGINS_FILE" ]] && command -v jq &>/dev/null && _plugin_check_needed; then
  PLUGIN_NAMES="$(jq -r '.plugins | keys[]' "$INSTALLED_PLUGINS_FILE" 2>/dev/null)"
  if [[ -n "$PLUGIN_NAMES" ]]; then
    UPDATED_PLUGINS=()
    while IFS= read -r plugin; do
      output="$(command claude plugin update "$plugin" 2>&1 || true)"
      # Check if the output indicates an actual update (not "already up to date")
      if [[ -n "$output" ]] && ! echo "$output" | grep -qi "already up.to.date\|no update\|up to date"; then
        UPDATED_PLUGINS+=("$plugin")
      fi
    done <<<"$PLUGIN_NAMES"

    if [[ ${#UPDATED_PLUGINS[@]} -gt 0 ]]; then
      echo "Updated plugins:"
      for p in "${UPDATED_PLUGINS[@]}"; do
        echo "  - $p"
      done
    fi
  fi
  # Record check timestamp regardless of whether updates were found
  date +%s >"$PLUGIN_CHECK_TIMESTAMP"
fi

claude_check_settings_backup

trap claude_check_settings_backup EXIT

simple_claudeish "$@"
